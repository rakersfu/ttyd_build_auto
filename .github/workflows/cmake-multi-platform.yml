name: Build ttyd and Release Ubuntu_1604_Static

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-ttyd:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Build ttyd inside Ubuntu 16.04 container (glibc 2.23)
      run: |
        docker run --rm -v $PWD:/build -w /build ubuntu:16.04 bash -c "
          set -e
          apt update &&
          DEBIAN_FRONTEND=noninteractive apt install -y \
            build-essential \
            git \
            curl ca-certificates \
            libjson-c-dev \
            libuv1-dev \
            file &&

          # Remove previous installations
          rm -rf /opt/ttyd /opt/libwebsockets /opt/openssl /opt/zlib

          # Set compiler flags for compatibility
          export CFLAGS='-O2 -march=x86-64 -mtune=generic'
          export CXXFLAGS='-O2 -march=x86-64 -mtune=generic'

          # Install CMake
          curl -LO https://github.com/Kitware/CMake/releases/download/v3.27.9/cmake-3.27.9-linux-x86_64.tar.gz &&
          tar -xzf cmake-3.27.9-linux-x86_64.tar.gz &&
          mv cmake-3.27.9-linux-x86_64 /opt/cmake &&
          export PATH=/opt/cmake/bin:\$PATH &&
          cmake --version &&

          # Build zlib (static)
          curl -LO https://zlib.net/zlib-1.2.13.tar.gz &&
          tar -xzf zlib-1.2.13.tar.gz &&
          cd zlib-1.2.13 &&
          ./configure --static --prefix=/opt/zlib &&
          make -j\$(nproc) &&
          make install &&
          cd /build &&

          # Build OpenSSL (static)
          curl -LO https://www.openssl.org/source/openssl-1.1.1u.tar.gz &&
          tar -xzf openssl-1.1.1u.tar.gz &&
          cd openssl-1.1.1u &&
          ./config --prefix=/opt/openssl no-shared &&
          make -j\$(nproc) &&
          make install &&
          cd /build &&

          # Build libwebsockets (static only)
          rm -rf libwebsockets &&
          git clone https://github.com/warmcat/libwebsockets.git -b v4.3.2 &&
          cd libwebsockets &&
          mkdir build && cd build &&
          cmake .. -DCMAKE_INSTALL_PREFIX=/opt/libwebsockets \
                   -DLWS_WITH_STATIC=ON \
                   -DLWS_WITH_SHARED=OFF \
                   -DLWS_WITH_SSL=ON \
                   -DLWS_WITH_LIBUV=ON \
                   -DOPENSSL_ROOT_DIR=/opt/openssl \
                   -DBUILD_SHARED_LIBS=OFF &&
          make -j\$(nproc) &&
          make install &&
          cd /build &&

          # Build ttyd (fully static)
          rm -rf ttyd &&
          git clone https://github.com/tsl0922/ttyd.git &&
          cd ttyd &&
          mkdir build && cd build &&
          cmake .. -DCMAKE_INSTALL_PREFIX=/opt/ttyd \
                   -DLibwebsockets_DIR=/opt/libwebsockets/lib/cmake/libwebsockets \
                   -DOPENSSL_ROOT_DIR=/opt/openssl \
                   -DZLIB_LIBRARY=/opt/zlib/lib/libz.a \
                   -DZLIB_INCLUDE_DIR=/opt/zlib/include \
                   -DBUILD_SHARED_LIBS=OFF \
                   -DCMAKE_EXE_LINKER_FLAGS='-static' &&
          make -j\$(nproc) &&
          make install &&

          # Copy built binary
          mkdir -p /build/output
          if [ -f /opt/ttyd/bin/ttyd ]; then
            cp /opt/ttyd/bin/ttyd /build/output/ttyd
            echo 'ttyd binary copied successfully'
          else
            echo 'ttyd binary not found, build failed'
            exit 1
          fi

          # Verify static linkage
          echo 'Checking static linkage with ldd:'
          ldd /build/output/ttyd || echo 'Static linkage confirmed: no dynamic dependencies'

          # Verify architecture
          echo 'Checking binary architecture with file:'
          file /build/output/ttyd
        "

    - name: Package build output
      run: |
        tar -czvf ttyd-static-build.tar.gz output

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ttyd-1.7.7-qnap-static
        name: "ttyd 1.7.7 Static Build (Ubuntu 16.04)"
        body: |
          ✅ Built inside Ubuntu 16.04 container (glibc 2.23)
          ✅ Fully statically linked with OpenSSL 1.1.1u, libwebsockets 4.3.2, and zlib 1.2.13
          ✅ Compatible with QNAP NAS, Debian 8/9, Ubuntu 16.04+, Alpine, BusyBox
          ✅ No runtime dependency on glibc ≥ 2.25
          ✅ libuv support enabled, mbedtls disabled
          ✅ CPU flags limited to x86-64 baseline — safe for older NAS
          ✅ Verified with ldd and file: no dynamic dependencies, no AVX/SSE4
        files: ttyd-static-build.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GH_PAT }}
