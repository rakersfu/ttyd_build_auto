name: Build ttyd and Release Ubuntu_1604

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-ttyd:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Build ttyd inside Ubuntu 16.04 container (glibc 2.23)
      run: |
        docker run --rm -v $PWD:/build -w /build ubuntu:16.04 bash -c "
          set -e
          apt update &&
          DEBIAN_FRONTEND=noninteractive apt install -y \
            build-essential \
            git \
            curl ca-certificates \
            libjson-c-dev \
            zlib1g-dev \
            libuv1-dev \
            file &&

          # é™åˆ¶ CPU æŒ‡ä»¤é›†ï¼Œç¡®ä¿å…¼å®¹ QNAP
          export CFLAGS='-O2 -march=x86-64 -mtune=generic'
          export CXXFLAGS='-O2 -march=x86-64 -mtune=generic'

          # æ„å»º OpenSSL
          curl -LO https://www.openssl.org/source/openssl-1.1.1u.tar.gz &&
          tar -xzf openssl-1.1.1u.tar.gz &&
          cd openssl-1.1.1u &&
          ./config --prefix=/opt/openssl no-shared &&
          make -j\$(nproc) &&
          make install &&
          cd /build &&

          # æ„å»º libwebsockets
          rm -rf libwebsockets &&
          git clone https://github.com/warmcat/libwebsockets.git -b v4.3.2 &&
          cd libwebsockets &&
          mkdir build && cd build &&
          cmake .. -DCMAKE_INSTALL_PREFIX=/opt/libwebsockets \
                   -DLWS_WITH_STATIC=ON \
                   -DLWS_WITH_SHARED=ON \
                   -DLWS_WITH_SSL=ON \
                   -DLWS_WITH_LIBUV=ON \
                   -DOPENSSL_ROOT_DIR=/opt/openssl &&
          make -j\$(nproc) &&
          make install &&
          cd /build &&

          # æ„å»º ttyd
          rm -rf ttyd &&
          git clone https://github.com/tsl0922/ttyd.git &&
          cd ttyd &&
          mkdir build && cd build &&
          cmake .. -DCMAKE_INSTALL_PREFIX=/opt/ttyd \
                   -DLibwebsockets_DIR=/opt/libwebsockets/lib/cmake/libwebsockets \
                   -DOPENSSL_ROOT_DIR=/opt/openssl &&
          make -j\$(nproc) &&
          make install &&

          # éªŒè¯å¹¶å¤åˆ¶ ttyd å¯æ‰§è¡Œæ–‡ä»¶
          mkdir -p /build/output
          if [ -f /opt/ttyd/bin/ttyd ]; then
            cp /opt/ttyd/bin/ttyd /build/output/ttyd
            echo 'âœ… ttyd binary copied'
          else
            echo 'âŒ ttyd å¯æ‰§è¡Œæ–‡ä»¶æœªæ‰¾åˆ°ï¼Œæ„å»ºå¤±è´¥'
            exit 1
          fi

          # éªŒè¯æ˜¯å¦ä¸ºé™æ€é“¾æ¥
          echo 'ğŸ” ldd æ£€æŸ¥ ttyd æ˜¯å¦ä¸ºé™æ€é“¾æ¥ï¼š'
          ldd /build/output/ttyd || echo 'âœ… é™æ€é“¾æ¥ç¡®è®¤ï¼šldd æ— æ³•è§£æï¼Œè¯´æ˜æ— ä¾èµ–'

          # éªŒè¯æ˜¯å¦ä½¿ç”¨åŸºç¡€æŒ‡ä»¤é›†
          echo 'ğŸ” file æ£€æŸ¥ CPU æ¶æ„ï¼š'
          file /build/output/ttyd
        "

    - name: Package build output
      run: |
        tar -czvf ttyd-build.tar.gz output

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ttyd-1.7.7-qnap
        name: "ttyd 1.7.7 Build (Ubuntu 16.04)"
        body: |
          âœ… Built inside Ubuntu 16.04 container (glibc 2.23)  
          âœ… Compatible with QNAP NAS, Debian 8/9, Ubuntu 16.04+, and other legacy systems  
          âœ… Statically linked with OpenSSL 1.1.1u and libwebsockets 4.3.2  
          âœ… No runtime dependency on glibc â‰¥ 2.25  
          âœ… libuv support enabled, mbedtls disabled  
          âœ… CPU flags limited to x86-64 baseline â€” safe for older NAS  
          âœ… Verified with ldd and file: no dynamic dependencies, no AVX/SSE4
        files: ttyd-build.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GH_PAT }}
